{% extends 'sales/base.html' %}
{% load crispy_forms_tags %}

{% block title %}{% if object %}Edit Quotation{% else %}New Quotation{% endif %} - Sales Management{% endblock %}
{% block header %}{% if object %}Edit Quotation{% else %}New Quotation{% endif %}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card">
            <div class="card-header bg-gradient">
                <h5 class="mb-0">
                    <i class="fas fa-file-alt me-2"></i>
                    {% if object %}Edit Quotation: {{ object.quotation_number }}{% else %}Create New Quotation{% endif %}
                </h5>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    <!-- Enhanced Customer Selection with Search -->
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <label class="form-label">Customer *</label>
                            <div class="position-relative">
                                <input type="text" class="form-control" id="customerSearch" placeholder="Search customers by name, email, or company..." autocomplete="off">
                                <input type="hidden" name="customer" id="customerId" required>
                                <div id="customerDropdown" class="dropdown-menu w-100" style="max-height: 300px; overflow-y: auto; display: none;">
                                    <!-- Customer search results will appear here -->
                                </div>
                            </div>
                            <div class="form-text">Type to search for existing customers</div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">&nbsp;</label>
                            <div>
                                <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#customerModal">
                                    <i class="fas fa-plus me-1"></i>Add New Customer
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Customer Preview -->
                    <div id="customerPreview" class="alert alert-info d-none mb-4">
                        <h6><i class="fas fa-user me-2"></i>Customer Details</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Name:</strong> <span id="previewName"></span></p>
                                <p class="mb-1"><strong>Email:</strong> <span id="previewEmail"></span></p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-1"><strong>Phone:</strong> <span id="previewPhone"></span></p>
                                <p class="mb-1"><strong>Company:</strong> <span id="previewCompany"></span></p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quotation Details -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <label class="form-label">Quotation Date *</label>
                            <input type="date" name="quotation_date" class="form-control" value="{{ today }}" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Valid Until *</label>
                            <input type="date" name="valid_until" class="form-control" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Tax Rate (%)</label>
                            <input type="number" name="tax_rate" class="form-control" step="0.01" min="0" max="100" value="5.00">
                        </div>
                    </div>

                    <!-- Items Section -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-list me-2"></i>Quotation Items
                                <button type="button" class="btn btn-primary btn-sm float-end" id="addItemBtn">
                                    <i class="fas fa-plus me-1"></i>Add Item
                                </button>
                            </h6>
                        </div>
                        <div class="card-body">
                            <div id="itemsContainer">
                                <!-- Items will be added here -->
                            </div>
                            
                            <!-- Add Item Form -->
                            <div class="row mb-3" id="newItemForm" style="display: none;">
                                <div class="col-md-5">
                                    <label class="form-label">Item/Service Description *</label>
                                    <div class="position-relative">
                                        <input type="text" class="form-control" id="itemDescription" placeholder="Type to search items or enter new description..." autocomplete="off">
                                        <div id="itemSuggestions" class="dropdown-menu w-100" style="max-height: 250px; overflow-y: auto; display: none;">
                                            <!-- Item suggestions will appear here -->
                                        </div>
                                    </div>
                                    <div class="form-text">Start typing to see matching items from previous quotations</div>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Quantity</label>
                                    <input type="number" class="form-control" id="itemQuantity" step="0.01" min="0.01" value="1">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Unit Price (QAR)</label>
                                    <input type="number" class="form-control" id="itemPrice" step="0.01" min="0">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Line Total</label>
                                    <input type="number" class="form-control" id="itemTotal" readonly>
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label">&nbsp;</label>
                                    <div>
                                        <button type="button" class="btn btn-success btn-sm" id="addItemToList">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button type="button" class="btn btn-secondary btn-sm" id="cancelAddItem">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Items Table -->
                            <div class="table-responsive">
                                <table class="table table-bordered" id="itemsTable">
                                    <thead>
                                        <tr>
                                            <th width="50%">Description</th>
                                            <th width="15%" class="text-center">Quantity</th>
                                            <th width="15%" class="text-end">Unit Price (QAR)</th>
                                            <th width="15%" class="text-end">Line Total (QAR)</th>
                                            <th width="5%" class="text-center">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="itemsTableBody">
                                        <!-- Items will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Totals Summary -->
                    <div class="row">
                        <div class="col-md-8">
                            <label class="form-label">Notes</label>
                            <textarea name="notes" class="form-control" rows="4" placeholder="Additional notes or terms...">{{ form.notes.value|default:'' }}</textarea>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">Quotation Summary</h6>
                                    <div class="d-flex justify-content-between">
                                        <span>Subtotal:</span>
                                        <span id="summarySubtotal">0.00 QAR</span>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span>Tax:</span>
                                        <span id="summaryTax">0.00 QAR</span>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between fw-bold">
                                        <span>Total:</span>
                                        <span id="summaryTotal">0.00 QAR</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between mt-4">
                        <a href="{% url 'quotation-list' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Back to List
                        </a>
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>{% if object %}Update{% else %}Create{% endif %} Quotation
                            </button>
                            {% if object %}
                                <a href="{% url 'quotation-pdf' object.pk %}" class="btn pdf-btn" target="_blank">
                                    <i class="fas fa-file-pdf me-2"></i>Download PDF
                                </a>
                            {% endif %}
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Customer Modal -->
<div class="modal fade" id="customerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Customer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="customerForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Name *</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email *</label>
                        <input type="email" class="form-control" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone</label>
                        <input type="text" class="form-control" name="phone">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Company</label>
                        <input type="text" class="form-control" name="company">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Address</label>
                        <textarea class="form-control" name="address" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveCustomer">Save Customer</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.dropdown-item:hover {
    background-color: #f8f9fa;
}

.dropdown-item:focus, .dropdown-item:active {
    background-color: #e9ecef;
}

.dropdown-menu {
    border: 1px solid #dee2e6;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    z-index: 1050;
}

.position-relative {
    position: relative !important;
}

mark {
    background-color: #fff3cd;
    padding: 0;
}

.search-highlight {
    background: linear-gradient(45deg, #007bff, #0056b3);
    color: white;
    padding: 2px 4px;
    border-radius: 2px;
    font-weight: 500;
}
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let itemIndex = 0;
    let items = [];
    
    // Existing items from database (for search suggestions)
    const existingItems = {{ existing_items|safe }};
    
    // Date handling - auto-set valid until date to 30 days from quotation date
    const quotationDate = document.querySelector('[name="quotation_date"]');
    const validUntil = document.querySelector('[name="valid_until"]');
    
    quotationDate.addEventListener('change', function() {
        if (this.value) {
            const date = new Date(this.value);
            date.setDate(date.getDate() + 30); // Add 30 days
            validUntil.value = date.toISOString().split('T')[0];
        }
    });
    
    // Set initial valid until date
    if (quotationDate.value && !validUntil.value) {
        quotationDate.dispatchEvent(new Event('change'));
    }
    
    // Advanced Customer Search
    const customerSearch = document.getElementById('customerSearch');
    const customerDropdown = document.getElementById('customerDropdown');
    const customerId = document.getElementById('customerId');
    const customerPreview = document.getElementById('customerPreview');
    let customerSearchTimeout;
    let allCustomers = [];

    // Load all customers for search
    fetch('{% url "search-customers" %}?q=', {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        allCustomers = data.customers || [];
        showCustomerSuggestions(allCustomers.slice(0, 10)); // Show first 10 initially
    });

    customerSearch.addEventListener('input', function() {
        const query = this.value.trim();
        clearTimeout(customerSearchTimeout);
        
        if (query.length === 0) {
            showCustomerSuggestions(allCustomers.slice(0, 10));
            return;
        }
        
        customerSearchTimeout = setTimeout(() => {
            searchCustomers(query);
        }, 300);
    });

    customerSearch.addEventListener('focus', function() {
        customerDropdown.style.display = 'block';
        if (allCustomers.length > 0 && !this.value) {
            showCustomerSuggestions(allCustomers.slice(0, 10));
        }
    });

    // Hide dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!customerSearch.contains(e.target) && !customerDropdown.contains(e.target)) {
            customerDropdown.style.display = 'none';
        }
    });

    function searchCustomers(query) {
        fetch(`{% url "search-customers" %}?q=${encodeURIComponent(query)}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            showCustomerSuggestions(data.customers || []);
        })
        .catch(error => {
            console.error('Customer search error:', error);
        });
    }

    function showCustomerSuggestions(customers) {
        if (customers.length === 0) {
            customerDropdown.innerHTML = '<div class="dropdown-item-text text-muted">No customers found</div>';
        } else {
            customerDropdown.innerHTML = customers.map(customer => `
                <button type="button" class="dropdown-item" onclick="selectCustomer(${customer.id}, '${customer.display_name.replace(/'/g, "\\'")}', '${customer.name.replace(/'/g, "\\'")}', '${customer.email}', '${customer.company || ''}', '')">
                    <div class="d-flex justify-content-between">
                        <div>
                            <strong>${customer.name}</strong>
                            ${customer.company ? `<br><small class="text-muted">${customer.company}</small>` : ''}
                        </div>
                        <small class="text-muted">${customer.email}</small>
                    </div>
                </button>
            `).join('');
        }
        customerDropdown.style.display = 'block';
    }

    window.selectCustomer = function(id, displayName, name, email, company, phone) {
        customerSearch.value = displayName;
        customerId.value = id;
        customerDropdown.style.display = 'none';
        
        // Update customer preview
        document.getElementById('previewName').textContent = name;
        document.getElementById('previewEmail').textContent = email;
        document.getElementById('previewPhone').textContent = phone || '';
        document.getElementById('previewCompany').textContent = company || '';
        customerPreview.classList.remove('d-none');
    };

    // Add item functionality
    const addItemBtn = document.getElementById('addItemBtn');
    const newItemForm = document.getElementById('newItemForm');
    const addItemToList = document.getElementById('addItemToList');
    const cancelAddItem = document.getElementById('cancelAddItem');
    
    addItemBtn.addEventListener('click', function() {
        newItemForm.style.display = 'flex';
        document.getElementById('itemDescription').focus();
    });
    
    cancelAddItem.addEventListener('click', function() {
        newItemForm.style.display = 'none';
        clearItemForm();
    });

    // Enhanced Item search functionality
    const itemDescription = document.getElementById('itemDescription');
    const itemSuggestions = document.getElementById('itemSuggestions');
    let itemSearchTimeout;
    
    itemDescription.addEventListener('input', function() {
        const query = this.value.trim();
        clearTimeout(itemSearchTimeout);
        
        if (query.length < 1) {
            itemSuggestions.style.display = 'none';
            return;
        }
        
        itemSearchTimeout = setTimeout(() => {
            searchItems(query);
        }, 200);
    });

    itemDescription.addEventListener('focus', function() {
        if (this.value.trim().length >= 1) {
            searchItems(this.value.trim());
        }
    });

    // Hide item suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (!itemDescription.contains(e.target) && !itemSuggestions.contains(e.target)) {
            itemSuggestions.style.display = 'none';
        }
    });

    function searchItems(query) {
        const matches = existingItems.filter(item => 
            item.description.toLowerCase().includes(query.toLowerCase())
        );
        
        if (matches.length > 0) {
            itemSuggestions.innerHTML = matches.map(item => `
                <button type="button" class="dropdown-item d-flex justify-content-between align-items-center" onclick="selectItem('${item.description.replace(/'/g, "\\'")}', ${item.unit_price})">
                    <div>
                        <strong>${highlightMatch(item.description, query)}</strong>
                        <br><small class="text-muted">Previous item</small>
                    </div>
                    <span class="badge bg-primary">${item.unit_price.toFixed(2)} QAR</span>
                </button>
            `).join('');
            
            // Add option to use as new item if no exact match
            const exactMatch = matches.some(item => 
                item.description.toLowerCase() === query.toLowerCase()
            );
            
            if (!exactMatch && query.length > 2) {
                itemSuggestions.innerHTML += `
                    <div class="dropdown-divider"></div>
                    <button type="button" class="dropdown-item" onclick="selectNewItem('${query.replace(/'/g, "\\'")}')">
                        <div>
                            <i class="fas fa-plus text-success me-2"></i><strong>Add "${query}" as new item</strong>
                            <br><small class="text-muted">Create new item/service</small>
                        </div>
                    </button>
                `;
            }
            
            itemSuggestions.style.display = 'block';
        } else if (query.length > 1) {
            itemSuggestions.innerHTML = `
                <button type="button" class="dropdown-item" onclick="selectNewItem('${query.replace(/'/g, "\\'")}')">
                    <div>
                        <i class="fas fa-plus text-success me-2"></i><strong>Add "${query}" as new item</strong>
                        <br><small class="text-muted">Create new item/service</small>
                    </div>
                </button>
            `;
            itemSuggestions.style.display = 'block';
        } else {
            itemSuggestions.style.display = 'none';
        }
    }

    function highlightMatch(text, query) {
        const regex = new RegExp(`(${query})`, 'gi');
        return text.replace(regex, '<mark>$1</mark>');
    }

    // Calculate line total
    const itemQuantity = document.getElementById('itemQuantity');
    const itemPrice = document.getElementById('itemPrice');
    const itemTotal = document.getElementById('itemTotal');
    
    function calculateLineTotal() {
        const quantity = parseFloat(itemQuantity.value) || 0;
        const price = parseFloat(itemPrice.value) || 0;
        itemTotal.value = (quantity * price).toFixed(2);
    }
    
    itemQuantity.addEventListener('input', calculateLineTotal);
    itemPrice.addEventListener('input', calculateLineTotal);

    // Add item to list
    addItemToList.addEventListener('click', function() {
        const description = itemDescription.value.trim();
        const quantity = parseFloat(itemQuantity.value);
        const price = parseFloat(itemPrice.value);
        const total = parseFloat(itemTotal.value);
        
        if (!description || quantity <= 0 || price <= 0) {
            alert('Please fill in all required fields with valid values.');
            return;
        }
        
        items.push({
            id: itemIndex++,
            description: description,
            quantity: quantity,
            unit_price: price,
            line_total: total
        });
        
        updateItemsTable();
        clearItemForm();
        newItemForm.style.display = 'none';
        calculateTotals();
    });

    // Update items table
    function updateItemsTable() {
        const tbody = document.getElementById('itemsTableBody');
        tbody.innerHTML = items.map(item => `
            <tr>
                <td>${item.description}</td>
                <td class="text-center">${item.quantity}</td>
                <td class="text-end">${item.unit_price.toFixed(2)}</td>
                <td class="text-end">${item.line_total.toFixed(2)}</td>
                <td class="text-center">
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeItem(${item.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
        
        // Add hidden inputs for form submission
        const form = document.querySelector('form');
        // Remove existing item inputs
        form.querySelectorAll('input[name^="items-"]').forEach(input => input.remove());
        
        // Add new item inputs
        items.forEach((item, index) => {
            ['description', 'quantity', 'unit_price', 'line_total'].forEach(field => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = `items-${index}-${field}`;
                input.value = item[field];
                form.appendChild(input);
            });
        });
    }

    // Calculate totals
    function calculateTotals() {
        const subtotal = items.reduce((sum, item) => sum + item.line_total, 0);
        const taxRate = parseFloat(document.querySelector('[name="tax_rate"]').value) || 0;
        const taxAmount = subtotal * (taxRate / 100);
        const total = subtotal + taxAmount;
        
        document.getElementById('summarySubtotal').textContent = subtotal.toFixed(2) + ' QAR';
        document.getElementById('summaryTax').textContent = taxAmount.toFixed(2) + ' QAR';
        document.getElementById('summaryTotal').textContent = total.toFixed(2) + ' QAR';
    }

    // Tax calculation
    document.querySelector('[name="tax_rate"]').addEventListener('input', calculateTotals);

    function clearItemForm() {
        itemDescription.value = '';
        itemQuantity.value = '1';
        itemPrice.value = '';
        itemTotal.value = '';
        itemSuggestions.style.display = 'none';
    }

    // Global functions
    window.selectItem = function(description, price) {
        itemDescription.value = description;
        itemPrice.value = price;
        calculateLineTotal();
        itemSuggestions.style.display = 'none';
        // Focus on quantity field for faster data entry
        itemQuantity.focus();
        itemQuantity.select();
    };

    window.selectNewItem = function(description) {
        itemDescription.value = description;
        itemSuggestions.style.display = 'none';
        // Focus on quantity field for faster data entry
        itemQuantity.focus();
        itemQuantity.select();
    };

    window.removeItem = function(id) {
        items = items.filter(item => item.id !== id);
        updateItemsTable();
        calculateTotals();
    };

    // Save new customer
    document.getElementById('saveCustomer').addEventListener('click', function() {
        const formData = new FormData(document.getElementById('customerForm'));
        
        fetch('{% url "customer-create" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Add new customer to the search system
                allCustomers.unshift({
                    id: data.customer.id,
                    name: data.customer.name,
                    email: data.customer.email,
                    company: data.customer.company || '',
                    phone: data.customer.phone || '',
                    display_name: data.customer.name + ' - ' + data.customer.email
                });
                
                // Select the newly created customer
                selectCustomer(
                    data.customer.id,
                    data.customer.name + ' - ' + data.customer.email,
                    data.customer.name,
                    data.customer.email,
                    data.customer.company || '',
                    data.customer.phone || ''
                );
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('customerModal'));
                modal.hide();
                
                // Reset form
                document.getElementById('customerForm').reset();
            } else {
                alert('Error creating customer: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            alert('Error creating customer: ' + error.message);
        });
    });
});
</script>
{% endblock %}